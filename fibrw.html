<form action="#" class="layui-form" id="search-form">

    <div class="layui-row">
        <div class="layui-col-xs5 layui-col-sm2 layui-col-md1">
            <div class="grid-demo">
                <input id="qNumInput" type="number" name="qNum" autocomplete="off" placeholder="é¢˜å·éå¿…é¡»"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-col-xs7 layui-col-sm3 layui-col-md2">
            <div class="grid-demo">
                <select name="type" id="typeselection">
                    <option value="-1">Cå“¥é˜…è¯»ä¸‹æ‹‰ç»¿è‰²é¢˜ç›®</option>
                    <option value="1">Cå“¥é˜…è¯»ä¸‹æ‹‰è“è‰²é¢˜ç›®</option>
                    <option value="2">Cå“¥é˜…è¯»ä¸‹æ‹‰é»„è‰²é¢˜ç›®</option>
<!--                    <option value="3">Cå“¥é˜…è¯»ä¸‹æ‹‰ç™½è‰²é¢˜ç›®</option>-->
                    <option value="4">Cå“¥é˜…è¯»ä¸‹æ‹‰å…¨éƒ¨é¢˜ç›®</option>
                    <!--                    <option value="5">è‡ªå®šä¹‰é¢˜ç›®1</option>-->
                    <!--                    <option value="6">è‡ªå®šä¹‰é¢˜ç›®2</option>-->
                    <option value="8">ğŸ¦é˜…è¯»ä¸‹æ‹‰æœˆé¢„æµ‹å‡å»Cå“¥ä¹‹å¤–é¢˜ç›®</option>
                    <option value="-5">Cå“¥é˜…è¯»ä¸‹æ‹‰å‡å»ğŸ¦æœˆé¢„æµ‹ä¹‹å¤–é¢˜ç›®</option>
<!--                    <option value="-2">ğŸ¦é˜…è¯»ä¸‹æ‹‰è¿‘æœŸè¶…é«˜é¢‘</option>-->
<!--                    <option value="-3">ğŸ¦é˜…è¯»ä¸‹æ‹‰è¿‘æœŸé«˜é¢‘</option>-->
<!--                    <option value="-4">ğŸ¦é˜…è¯»ä¸‹æ‹‰è¶…è¿‘æœŸæ›´æ–°</option>-->
                    <option value="7">é˜…è¯»ä¸‹æ‹‰æ”¶è—å¤¹</option>
                    <option value="9">é”™é¢˜é›†</option>
                </select>
            </div>
        </div>
        <div class="layui-hide-xs layui-col-sm3 layui-col-md3">
            <div class="grid-demo">
                <label class="layui-form-label" style="color: red">å¯é€‰é€‰é¡¹:</label>
                <div class="layui-input-block">
                    <input type="checkbox" name="autonext" title="è‡ªåŠ¨ä¸‹ä¸€é¢˜">
                    <input type="checkbox" name="trans" title="å…¨æ–‡ç¿»è¯‘">
                    <input type="checkbox" name="onlyundo" title="ä»…æ˜¾ç¤ºæœªåš">
                </div>
            </div>
        </div>
        <div class="layui-col-xs12 layui-col-sm4 layui-col-md5">
                <button class="layui-btn layui-btn-sm" lay-header-event="search">åŠ è½½(æœç´¢)é¢˜ç›®</button>
                <button class="layui-btn layui-btn-sm" lay-header-event="testlucky">è¯•è¯•æ‰‹æ°”</button>
                <button class="layui-btn layui-btn-sm" lay-header-event="cleanfav">æ¸…ç©ºæ”¶è—å¤¹</button>
                <button class="layui-btn layui-btn-sm" lay-header-event="deleteallrightorfalt">æ¸…ç©ºå¯¹é”™è®°å½•</button>

        </div>
        <div class="layui-col-sm2 layui-col-md1 layui-hide-xs">
            <button class="layui-btn layui-btn-sm" lay-header-event="uncompleted" id="uncompleted">ä¸å®Œæ•´é¢˜ç›®
            </button>
        </div>
    </div>
</form>


<form class="layui-form" action="" id="question-form" style="margin-top: 30px">
    <div class="layui-row">
        <div id="question-div" class="layui-col-xs12 layui-col-sm12 layui-col-md12"
             style="padding-left: 20px;padding-right: 20px;line-height: 30px;"></div>

        <div class="layui-form-item" id="operationtools" class="layui-col-xs12 layui-col-sm12 layui-col-md12"
             hidden="hidden" style="margin-top: 30px">


            <div class="layui-input-block">
                <div class="grid-demo layui-col-xs12 layui-col-sm2 layui-col-md2 layui-col-lg2">
                    <button type="submit" class="layui-btn layui-btn-sm layui-col-xs4" lay-submit
                            lay-header-event="checkanswer" lay-filter="demo1"
                            layui-btn layui-btn-sm>
                        æ£€æŸ¥ç­”æ¡ˆ
                    </button>
                    <button class="layui-btn layui-btn-sm" id="showanswer" lay-header-event="showanswer" layui-btn
                            layui-btn-sm>æ˜¾ç¤º/éšè—ç­”æ¡ˆ
                    </button>


                </div>
                <div class="grid-demo layui-col-xs12 layui-col-sm2 layui-col-md2 layui-col-lg2">
                    <button class="layui-btn layui-btn-sm " id="pre" lay-header-event="pre" layui-btn
                            layui-btn-sm>ä¸Šä¸€é¢˜
                    </button>
                    <button class="layui-btn layui-btn-sm" id="next" lay-header-event="next" layui-btn
                            layui-btn-sm>ä¸‹ä¸€é¢˜
                    </button>
                </div>

                <div class="grid-demo  layui-col-xs12 layui-col-sm1 layui-col-md1 layui-col-lg1">
                    <button class="layui-btn layui-btn-sm" id="adddeletefav" lay-header-event="adddeletefav" layui-btn
                            layui-btn-sm>æ·»åŠ åˆ°æ”¶è—
                    </button>

                </div>

                <div class="grid-demo  layui-col-xs12 layui-col-sm2 layui-col-md2 layui-col-lg2">
                    <div class="grid-demo  layui-col-xs6 layui-col-sm6">
                        <input type="number" id="qindex" name="price_min" placeholder="ç¬¬å‡ é¢˜" autocomplete="off"
                               class="layui-input" min="0" step="1" lay-affix="number">
                    </div>

                    <div class="grid-demo  layui-col-xs6 layui-col-sm6">
                        <button class="layui-btn layui-btn-sm" id="gotoindex" lay-header-event="gotoindex">è·³è½¬
                        </button>
                    </div>
                </div>
                <div class="grid-demo  layui-col-xs12 layui-col-sm4 layui-col-md4 layui-col-lg3">
                    <div class="layui-inline layui-hide-xs" id="rightandfalt"></div>
                    <div class="layui-inline">
                        <button class="layui-btn layui-btn-sm" id="clearrightorfalt"
                                lay-header-event="clearrightorfalt">åˆ é™¤å¯¹é”™è®°å½•
                        </button>
                    </div>
                </div>
                <div class="grid-demo  layui-col-xs4 layui-col-sm1 layui-col-md1 layui-col-lg1">
                    <div class="layui-inline">
                        <button class="layui-btn layui-btn-sm" id="gotoaepui"
                                lay-header-event="gotoaepui">è·³è½¬åˆ°ğŸ¦åˆ·æœ¬é¢˜
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
<div class="layui-form-item" id="chineseandanswer">

<pre class="layui-code answer-area" lay-options="{}" id="answer-area" style="font-size: 18px;font-family: Arial">
</pre>
</div>


<script type="text/javascript">
    var localStorageType = "fibrw";
    layui.use(['table', 'layer', 'form', 'util'], function () {
        var table = layui.table;
        var layer = layui.layer;
        var form = layui.form;
        var util = layui.util;
        $("#question-form").hide();
        $("#uncompleted").hide();
        fibrwInit();
        form.render();
        $("#chineseandanswer").hide();
        util.event('lay-header-event', {
            search: function (obj, event) { // å·¦ä¾§èœå•äº‹ä»¶
                //  var json = JSON.stringify($("#search-form").serializeJson())
                // alert("aaaaa" + json)
                event.preventDefault();
                $("#pre").hide();
                // var content = fibRwGetdata($("#search-form").serializeJson());
                fibRwCurrentTypedata($("#search-form").serializeJson())
                var fibrwdata = currentFibRWData();
                if (!fibrwdata) {
                    $("#question-form").hide();
                    layer.msg('å½“å‰åˆ†ç±»ä¸‹ä¸å­˜åœ¨è¯¥é¢˜ç›®', {icon: 0}, function () {
                        // layer.msg('æç¤ºæ¡†å…³é—­åçš„å›è°ƒ');
                    });
                    return false;
                } else {
                    $("#question-form").show();

                }
                var content = fibrwTranslateData(fibrwdata);
                $("#question-div").html(content);
                fillfibrwAnswer(fibrwdata);
                if (isFibRwLast()) {
                    $("#next").hide();
                } else {
                    $("#next").show();
                }
                if (getFibRwTotalNum() == 1) {
                    $("#gotoarea").hide();
                } else {
                    $("#gotoarea").show();
                }
                checkFav(fibrwdata.num, localStorageType);
                form.render();
                return false;
            }, testlucky: function (obj, event) { // å·¦ä¾§èœå•äº‹ä»¶
                //  var json = JSON.stringify($("#search-form").serializeJson())
                // alert("aaaaa" + json)
                event.preventDefault();
                $("#pre").hide();
                // var content = fibRwGetdata($("#search-form").serializeJson());
                var fibrwdata = fibrwRandomLucky();
                if (!fibrwdata) {
                    $("#question-form").hide();
                    layer.msg('åŠ è½½èµ„æºä¸­,ç­‰ä¸€ä¸‹ç‚¹å‡»æˆ–è€…åˆ·æ–°ä¸€ä¸‹é‡æ–°æµ‹è¯•', {icon: 0}, function () {
                        // layer.msg('æç¤ºæ¡†å…³é—­åçš„å›è°ƒ');
                    });
                    return false;
                } else {
                    $("#question-form").show();
                }
                var content = fibrwTranslateData(fibrwdata);
                $("#question-div").html(content);
                fillfibrwAnswer(fibrwdata);
                if (isFibRwLast()) {
                    $("#next").hide();
                } else {
                    $("#next").show();
                }
                if (getFibRwTotalNum() == 1) {
                    $("#gotoarea").hide();
                } else {
                    $("#gotoarea").show();
                }
                checkFav(fibrwdata.num, localStorageType);
                form.render();
                return false;
            },
            cleanfav: function (obj,event){
                event.preventDefault();
                cleanfibrwfav()
            },
            deleteallrightorfalt: function (obj, event) {
                event.preventDefault();
                //ç§»é™¤æ‰€æœ‰æ•°æ®
                layer.confirm('æ˜¯å¦åˆ æ¸…ç©ºæœ¬é¢˜å‹çš„å¯¹é”™è®°å½•ï¼Ÿ', {icon: 3}, function () {
                    clearAllFaltByType(localStorageType);
                    try {
                        var fibrwdata = currentFibRWData();
                        if (fibrwdata) {
                            setRightAndFaltNum(fibrwdata.num, localStorageType);
                        }
                    } catch (e) {

                    }
                    layer.msg('æ“ä½œå®Œæˆ', {icon: 0}, function () {
                    });
                }, function () {
                    return;
                });
            },
            clearrightorfalt: function (obj, event) {
                event.preventDefault();

                layer.confirm('æ˜¯å¦åˆ é™¤æœ¬é¢˜çš„å¯¹é”™è®°å½•ï¼Ÿ', {icon: 3}, function () {
                    var fibrwdata = currentFibRWData();
                    if (fibrwdata) {
                        deleteRightOrFaltByQnum(fibrwdata.num, localStorageType);
                        setRightAndFaltNum(fibrwdata.num, localStorageType);
                    }
                    layer.msg('æ“ä½œå®Œæˆ', {icon: 0}, function () {
                    });
                }, function () {
                });
            },
            uncompleted: function (obj, event) {
                event.preventDefault();
                fibrwUncompleted();

            },
            next: function (obj, event) {
                var result = nextFibRwQuestion(obj, event, localStorageType);

                form.render();
                return result;
            },
            pre: function (obj, event) {
                event.preventDefault();
                if (isFibRwFirst()) {
                    $("#pre").hide();
                    return false;
                }

                // var content = fibrwPreQuest();
                var fibrwdata = fibrwPreQuest();
                var content = fibrwTranslateData(fibrwdata);
                if (isFibRwFirst()) {
                    $("#pre").hide();
                }
                if (!isFibRwLast()) {
                    $("#next").show();
                }
                $("#question-div").html(content);
                fillfibrwAnswer(fibrwdata);
                checkFav(fibrwdata.num, localStorageType);
                form.render();
                return false;
            },
            checkanswer: function (obj, event) {
                event.preventDefault();
                var fibrwdata = currentFibRWData();
                var content = JSON.stringify($("#question-form").serializeJson());
                var result = $("#question-form").serializeJson();
                var isWrong = false;
                for (var ans in result) {
                    if (!ans || !ans.startsWith("answer")) {
                        continue;
                    }
                    console.log(result[ans]);
                    var answer = result[ans];
                    var select = $("#" + ans);
                    console.log($(select))
                    if (!answer || answer.startsWith("false")) {
                        // $(allSelects[i]).addClass("layui-form-danger");
                        $(select).removeClass();
                        $(select).attr("class", "layui-form-danger");
                        isWrong = true;
                    }

                }
                if (!isWrong) {
                    addRightOrFalt(fibrwdata.num, "right", localStorageType);
                    layer.msg('å…¨éƒ¨æ­£ç¡®,è€ƒè¯•å¿…è¿‡!', {icon: 0, time: 800}, function () {
                        var serializeJson = $("#search-form").serializeJson();
                        var autonext = serializeJson.autonext;
                        //æ·»åŠ æ­£ç¡®æ¬¡æ•°,æ·»åŠ é”™è¯¯æ¬¡æ•°
                        // layer.msg('æç¤ºæ¡†å…³é—­åçš„å›è°ƒ');
                        if (!isFibRwLast()&&autonext) {
                            nextFibRwQuestion(obj, event, localStorageType);
                            form.render();
                        }
                    });
                } else {
                    addRightOrFalt(fibrwdata.num, "falt", localStorageType);
                    layer.msg('ç­”æ¡ˆä¸å°å¿ƒé€‰é”™äº†å“Ÿ!', {icon: 0}, function () {
                        // layer.msg('æç¤ºæ¡†å…³é—­åçš„å›è°ƒ');
                        //æ·»åŠ é”™è¯¯æ¬¡æ•°
                    });
                }
                setRightAndFaltNum(fibrwdata.num, localStorageType);
            },
            showanswer: function (obj, event) {
                event.preventDefault();
                if ($("#chineseandanswer").is(":hidden")) {
                    $("#chineseandanswer").show();
                } else {
                    $("#chineseandanswer").hide();
                }
            },
            gotoindex: function (obj, event) {
                event.preventDefault();
                var qIndex = $("#qindex").val();//æƒ³è¦è·³è½¬çš„é¢˜ç›®
                console.log(qIndex);
                if (!qIndex || qIndex <= 0 || qIndex > getFibRwTotalNum) {

                } else {
                    setFibRWIndex(parseInt(qIndex));
                    var fibrwdata = currentFibRWData();
                    if (!fibrwdata) {
                        layer.msg('è¶…å‡ºé¢˜ç›®æ•°é‡èŒƒå›´', {icon: 0}, function () {
                        });
                        return false;
                    }
                    var content = fibrwTranslateData(fibrwdata);
                    if (isFibRwFirst()) {
                        $("#pre").hide();
                    } else {
                        $("#pre").show();
                    }
                    if (!isFibRwLast()) {
                        $("#next").show();
                    } else {
                        $("#next").hide();
                    }
                    $("#question-div").html(content);
                    fillfibrwAnswer(fibrwdata);
                    checkFav(fibrwdata.num, localStorageType);
                    form.render();
                    return false;
                }


            },
            adddeletefav: function (obj, event) {
                event.preventDefault();


                var fibrwdata = currentFibRWData();
                if (!fibrwdata) {
                    layer.msg('é¢˜ç›®æ— æ•ˆ', {icon: 0}, function () {
                    });
                    return false;
                }
                var isContains = containsValue(fibrwdata.num, localStorageType);
                if (isContains) {
                    layer.confirm('æ˜¯å¦åˆ é™¤æ”¶è—ï¼Ÿ', {icon: 3}, function () {
                        removeFavFromLocalStorage(fibrwdata.num, localStorageType);
                        layer.msg('æ“ä½œå®Œæˆ', {icon: 0}, function () {
                        });
                        checkFav(fibrwdata.num, localStorageType);
                    }, function () {
                    });

                } else {
                    layer.confirm('æ˜¯å¦æ·»åŠ åˆ°æ”¶è—ï¼Ÿ', {icon: 3}, function () {
                        add2LocalStorage("fibrwblue", fibrwdata.num, localStorageType)
                        layer.msg('æ“ä½œå®Œæˆ', {icon: 0}, function () {
                        });
                        checkFav(fibrwdata.num, localStorageType);
                    }, function () {
                    });

                }

            },
            gotoaepui: function (obj,event){
                event.preventDefault();
                var data = currentFibRWData();
                var qNum = data.num;
                var local = "cn";
                if (!cnMap.get(qNum)) {
                    local = "en";
                }
                gotoxj(local, "fib_wr", qNum);
            }
        });
        // è‡ªå®šä¹‰éªŒè¯è§„åˆ™
        form.verify({
            answer: function (value) {

                if (value.startsWith("false")) {
                    return "ç­”æ¡ˆä¸å°å¿ƒé€‰é”™äº†å“Ÿ";
                }
            }
        });
    })
    $.fn.serializeJson = function () {
        var serializeObj = {};
        var array = this.serializeArray();
        $.each(array, function () {
            if (serializeObj[this.name] !== undefined) {
                if (!serializeObj[this.name].push) {
                    serializeObj[this.name] = [serializeObj[this.name]];
                }
                serializeObj[this.name].push(this.value || '');
            } else {
                serializeObj[this.name] = this.value || '';
            }
        });
        return serializeObj;
    };

    function fillfibrwAnswer(fibrwdata) {
        $("#operationtools").show();
        var chinese = getChinese(fibrwdata.num + "");
        var chinesespan = $("#chinesespan");
        if (chinesespan) {
            chinesespan.remove();
        }
        if (chinese) {
            var chinesepre = "<span id='chinesespan' style=\"font-size:20px;color:red;margin: 40px\">";
            var chinesebiaoshipre = "<span style=\"font-size:20px;color:green;\">";
            var sPanend = "</span>"
            chinese = chinese.replaceAll("ã€", chinesebiaoshipre + "ã€" + sPanend)
            chinese = chinese.replaceAll("ã€‘", chinesebiaoshipre + "ã€‘" + sPanend);
            chinese = chinesepre + chinese + sPanend;
            $("#chineseandanswer").prepend(chinese);
        }

        $("#chineseandanswer").hide();
        var answerInText = fibrwdata.answer_in_text;
        var explanation_in_locale = fibrwdata.explanation_in_locale;
        var answercontent = "</br>" + "</br>" + answerInText + "</br>" + "</br>" + explanation_in_locale;

        var params = $("#search-form").serializeJson();
        var needTrans = params.trans;
        if (needTrans) {
            var contents = fibrwdata.contents;
            if (contents && contents.length > 0) {
                answercontent = answercontent + "<br/>" + "<br/>"+ "<br/>"+ "ç¿»è¯‘:" + "<br/>"
                    contents.forEach((eachContent) => {
                        var type = eachContent.type;
                        if (type == "option" || type == "caption") {
                        } else {
                            var content = eachContent.content;
                            answercontent = answercontent + "<br/>" + content + "<br/>";
                        }
                    });
            }else{
                answercontent = answercontent + "<br/>æœ¬é¢˜æš‚æ— ç¿»è¯‘<br/>";
            }
        }
        $("#answer-area").html(answercontent);
        setRightAndFaltNum(fibrwdata.num, localStorageType);
    }

    function nextFibRwQuestion(obj, event, localStorageType) {
        event.preventDefault();
        if (isFibRwLast()) {
            $("#next").hide();
            return false;
        }

        var fibrwdata = fibrwNextQuest();
        var content = fibrwTranslateData(fibrwdata);
        if (isFibRwLast()) {
            $("#next").hide();
        }
        $("#question-div").html(content);
        fillfibrwAnswer(fibrwdata);
        if (!isFibRwFirst()) {
            $("#pre").show();
        }
        checkFav(fibrwdata.num, localStorageType);
        return false;
    }
</script>
